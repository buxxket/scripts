#!/usr/bin/env bash

FOLDER=~/pictures/wallpapers/
USE_RANDOM=0

pywal16() {
	wal -i $WALLPAPER --cols16 darken --contrast 3 --saturate 0.7 -s
}

fill-and-merge() {
	feh --bg-fill $1
	ln -sf ~/.cache/wal/colors.Xresources ~/.Xresources
	cat ~/.Xresources ~/.cache/wal/xrdb_extra | xrdb -merge
	echo "Xcursor.size: 24" >> ~/.Xresources
	xdotool key super+ctrl+backslash # xrdb refresh keybind
}

apply-kitty-theme() {
	local THEME_FILE="$HOME/.cache/wal/colors-kitty.conf"

	# 	# First, check if the file exists
	# 	if [[ -f "$THEME_FILE" ]]; then
	# 		# Append or replace color1 and color8 at the end of the file
	# 		# Remove any existing color1 or color8 definitions first
	# 		sed -i '/^color1 /d' "$THEME_FILE"
	# 		sed -i '/^color8 /d' "$THEME_FILE"
	# 	else
	# 		touch "$THEME_FILE"
	# 	fi
	#
	# 	# Append custom overrides
	# 	cat <<EOF >>"$THEME_FILE"
	# color1 #cc6666
	# color8 #7f7f7f
	# EOF

	# Apply to all kitty instances
	for socket in /tmp/kitty_pywal-*; do
		if [[ -S "$socket" ]]; then
			kitty @ --to unix:"$socket" set-colors --all --configured "$THEME_FILE"
		fi
	done
}

while getopts ":i:r" opt; do
	case $opt in
	i) WALLPAPER=${OPTARG} ;;
	r) USE_RANDOM=1 ;;
	esac
done

if [[ "$USE_RANDOM" == "1" ]]; then
	FILE=$(ls "$FOLDER" | shuf -n 1)
	WALLPAPER=$FOLDER$FILE
	pywal16
	fill-and-merge $WALLPAPER
	apply-kitty-theme
	exit
elif [[ -n $WALLPAPER ]]; then
	pywal16
	fill-and-merge $WALLPAPER
	apply-kitty-theme
	exit
else
	if command -v nsxiv >/dev/null; then
		WALLPAPER=$(nsxiv -otb $FOLDER/*)
		pywal16
		fill-and-merge $WALLPAPER
		apply-kitty-theme
	else
		echo "nsxiv not found"
		exit 1
	fi
fi
